<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr Key Converter (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/noble-secp256k1@1.2.14/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/base58-js@2.0.0/base58.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bech32@2.0.0/dist/index.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-4 text-center">Nostr Key Converter</h1>
        
        <!-- Security Warning -->
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8" role="alert">
            <p class="font-bold">⚠️ Security Warning</p>
            <p>Never enter private keys (nsecs) on any website while connected to the internet. Always perform private key operations offline.</p>
        </div>

        <!-- Tabs -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex" aria-label="Tabs">
                    <button onclick="switchTab('public')" class="tab-btn active w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm" data-tab="public">
                        Public Keys (npub)
                    </button>
                    <button onclick="switchTab('private')" class="tab-btn w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm" data-tab="private">
                        Private Keys (nsec)
                    </button>
                </nav>
            </div>
        </div>

        <!-- Input Area -->
        <div class="mb-8">
            <textarea id="input" rows="4" class="w-full p-4 border rounded-lg shadow-sm" 
                      placeholder="Enter Nostr keys (one per line)"></textarea>
            <button onclick="convertKeys()" class="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Convert
            </button>
        </div>

        <!-- Results Area -->
        <div id="results" class="grid grid-cols-1 gap-6"></div>

        <!-- Templates -->
        <template id="public-result-template">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Input Key</h3>
                    <p class="text-sm text-gray-500 break-all"></p>
                </div>
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700">Legacy Address (P2PKH)</h4>
                    <div class="flex items-center mt-1">
                        <input type="text" readonly class="flex-1 p-2 text-sm bg-gray-50 rounded border">
                        <button onclick="copyToClipboard(this)" class="ml-2 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Copy
                        </button>
                    </div>
                    <div class="qr-code mt-2"></div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-700">Native SegWit Address (P2WPKH)</h4>
                    <div class="flex items-center mt-1">
                        <input type="text" readonly class="flex-1 p-2 text-sm bg-gray-50 rounded border">
                        <button onclick="copyToClipboard(this)" class="ml-2 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Copy
                        </button>
                    </div>
                    <div class="qr-code mt-2"></div>
                </div>
            </div>
        </template>

        <template id="private-result-template">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Input Key</h3>
                    <p class="text-sm text-gray-500 break-all"></p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-700">Bitcoin WIF</h4>
                    <div class="flex items-center mt-1">
                        <input type="text" readonly class="flex-1 p-2 text-sm bg-gray-50 rounded border">
                        <button onclick="copyToClipboard(this)" class="ml-2 px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Copy
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        // Utility Functions
        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < bytes.length; i++) {
                bytes[i] = parseInt(hex.substr(i * 2, 2), 16);
            }
            return bytes;
        }

        function bytesToHex(bytes) {
            return Array.from(bytes)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        function sha256(data) {
            return crypto.subtle.digest('SHA-256', data);
        }

        async function doubleSha256(data) {
            const firstHash = await sha256(data);
            return sha256(firstHash);
        }

        async function base58Check(data, version) {
            const versionedData = new Uint8Array(data.length + 1);
            versionedData[0] = version;
            versionedData.set(data, 1);
            
            const checksum = new Uint8Array(await doubleSha256(versionedData)).slice(0, 4);
            const final = new Uint8Array(versionedData.length + 4);
            final.set(versionedData);
            final.set(checksum, versionedData.length);
            
            return base58.encode(final);
        }

        // UI Functions
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active', 'border-blue-500', 'text-blue-600');
                    btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                } else {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });
            
            // Clear results and input
            document.getElementById('results').innerHTML = '';
            document.getElementById('input').value = '';
        }

        async function convertKeys() {
            const input = document.getElementById('input').value.trim();
            const lines = input.split('\n').filter(line => line.trim());
            const results = document.getElementById('results');
            results.innerHTML = '';

            const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
            const template = document.getElementById(`${activeTab}-result-template`);

            for (const line of lines) {
                const clone = template.content.cloneNode(true);
                clone.querySelector('p').textContent = line;

                if (activeTab === 'public') {
                    await convertPublicKey(line, clone);
                } else {
                    await convertPrivateKey(line, clone);
                }

                results.appendChild(clone);
            }
        }

        async function convertPublicKey(npub, template) {
            try {
                // Decode npub
                const decoded = bech32.decode(npub);
                if (decoded.prefix !== 'npub') throw new Error('Invalid npub');
                
                const pubkeyBytes = new Uint8Array(bech32.fromWords(decoded.words));
                
                // Generate Legacy address
                const sha256Hash = await sha256(pubkeyBytes);
                const ripemd160Hash = new Uint8Array(await crypto.subtle.digest('RIPEMD-160', sha256Hash));
                const legacyAddress = await base58Check(ripemd160Hash, 0x00);
                
                // Generate Native SegWit address
                const words = bech32.toWords(ripemd160Hash);
                const bech32Address = bech32.encode('bc', [0].concat(words));

                // Update UI
                const inputs = template.querySelectorAll('input');
                inputs[0].value = legacyAddress;
                inputs[1].value = bech32Address;

                // Generate QR codes
                const qrDivs = template.querySelectorAll('.qr-code');
                await QRCode.toCanvas(qrDivs[0], legacyAddress, { width: 128 });
                await QRCode.toCanvas(qrDivs[1], bech32Address, { width: 128 });
            } catch (error) {
                console.error('Error converting public key:', error);
            }
        }

        async function convertPrivateKey(nsec, template) {
            if (window.navigator.onLine) {
                template.querySelector('input').value = 'ERROR: Must be offline for private key operations';
                return;
            }

            try {
                // Decode nsec
                const decoded = bech32.decode(nsec);
                if (decoded.prefix !== 'nsec') throw new Error('Invalid nsec');
                
                const privkeyBytes = new Uint8Array(bech32.fromWords(decoded.words));
                
                // Convert to WIF
                const wif = await base58Check(privkeyBytes, 0x80);
                template.querySelector('input').value = wif;
            } catch (error) {
                console.error('Error converting private key:', error);
                template.querySelector('input').value = 'Error: Invalid private key';
            }
        }

        function copyToClipboard(button) {
            const input = button.parentElement.querySelector('input');
            navigator.clipboard.writeText(input.value).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                button.classList.add('bg-green-500', 'hover:bg-green-600');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    button.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 2000);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            switchTab('public');
        });
    </script>
</body>
</html> 